# `lc-phonecontrol-plugin`
## DEV documentation

This plugin implements a server to connect to an Android phone and control it from LifeCompanion.  
The server is able to work with ADB ~~and Bluetooth~~.

### Build the plugin
The recommended way to build the plugin is to use `./gradlew clean buildApp downloadAdb jar`.  
- `clean` : Cleans the project, removes any previous build artifacts.
- `buildApp` : Builds the APK of the Android app (unsigned) and moves it to the plugin's resources.
- `downloadAdb` : Downloads the ADB binaries for the current platform and moves them to the plugin's resources.
- `jar` : Builds the plugin JAR file.

If you only made changes to the plugin, you can run only `./gradlew jar`. APK and ADB artifacts are kept in the app's resources directory.

### JSON schema specification
The plugin and the phone communicate via the server through JSON messages.  
The JSON format is structured to contain metadata about the sender, the type of transmission, subtype, and the data itself. This allows the server to properly interpret what action is required, be it sending an SMS, making a call, or handling volume settings. Below, we outline all possible fields, their meanings, and examples.
```json
{
  "sender": "<pc|phone>",
  "type": "<call|sms|system>",
  "subtype": "<specific subtype>",
  "request_id": "<unique identifier>",
  "data": {
    "<object containing>": "<specific information>"
  }
}
```
- **sender**: Indicates which entity is initiating the transmission.
  - Values: `"pc"` or `"phone"`
- **type**: Represents the type of transmission.
  - Values: `"call"`, `"sms"`, `"system"`
- **subtype**: Provides more specific information related to the type.
  - Subtype values vary depending on `type`.
- **request_id**: A unique identifier for the request.
  - This field is optional and can be used to track requests.
  - It is generated by the sender and can be any string (usually a UUID v4).
  - The server will return the same `request_id` in the response.
- **data**: Contains a JSON object relevant to the action :

#### Type : **call**
**Subtypes** :
  1. **"make_call"**
    - Description : Initiates a call to a specified number.
    - Data example :
      ```json
      {
        "phone_number": "+123456789",
        "speaker_on": true
      }
      ```
  2. **"hang_up"**
    - Description : Ends an active call.
    - Data example : `{}` (Empty data)
  3. **"numpad_input"**
    - Description : Sends DTMF (Dual-Tone Multi-Frequency) input, used for interacting with automated systems.
    - Data example :
      ```json
      {
        "dtmf": "1"
      }
      ```
  4. **get_call_status**
    - Description : Requests the current call status.
    - Data example : `{}` (Empty data)

#### Type : **sms**
**Subtypes** :
  1. **"send_sms"**
    - Description: Sends an SMS to a specified recipient.
    - Data example :
      ```json
      {
        "recipient": "+123456789",
        "message": "Hello, how are you?"
      }
      ```
  2. **"get_sms_conversations"**
    - Description : Requests a list of SMS conversations within a range.
    - Data example :
      ```json
      {
        "conv_index_min": 0,
        "conv_index_max": 4
      }
      ```
  3. **"get_conversation_messages"**
    - Description : Gets messages from a specific conversation within a range.
    - Data example :
      ```json
      {
        "contact_number": "+123456789",
        "msg_index_min": 0,
        "msg_index_max": 3
      }
      ```

#### Type : **system**
**Subtype** : **"adjust_volume"**
  - Description : Adjusts the phone's volume.
  - Values can be "increase" or "decrease".
  - Data example :
    ```json
    {
      "mode": "increase"
    }
    ```

#### Example JSON objects - PC to phone
1. **Sending an SMS**
  ```json
  {
    "sender": "pc",
    "type": "sms",
    "subtype": "send_sms",
    "request_id": "123e4567-e89b-12d3-a456-426614174000",
    "data": {
      "recipient": "+123456789",
      "message": "Hello, this is a test message"
    }
  }
  ```
2. **Adjusting volume**
  ```json
  {
    "sender": "pc",
    "type": "system",
    "subtype": "adjust_volume",
    "data": {
      "mode": "decrease"
    }
  }
  ```
3. **Making a call**
  ```json
  {
    "sender": "pc",
    "type": "call",
    "subtype": "make_call",
    "request_id": "123e4567-e89b-12d3-a456-426614174000",
    "data": {
      "phone_number": "+123456789",
      "speaker_on": true
    }
  }
  ```
4. **List SMS conversations**
  ```json
  {
    "sender": "pc",
    "type": "sms",
    "subtype": "get_sms_conversations",
    "request_id": "123e4567-e89b-12d3-a456-426614174000",
    "data": {
      "conv_index_min": 0,
      "conv_index_max": 4
    }
  }
  ```

#### Example JSON objects - Phone to PC
1. **Get call status**
  ```json
  {
    "sender": "phone",
    "type": "call",
    "subtype": "get_call_status",
    "request_id": "123e4567-e89b-12d3-a456-426614174000",
    "data": {
      "call_status": "active", // or "inactive"
      "incoming_call_status": "incoming", // or "none"
      "phone_number": "+123456789" // only if incoming_call_status is "incoming"
    }
  }
  ```
2. **Get a confirmation that an SMS was sent**
  ```json
  {
    "sender": "phone",
    "type": "sms",
    "subtype": "send_sms",
    "request_id": "123e4567-e89b-12d3-a456-426614174000",
    "data": {
      "recipient": "+123456789",
      "is_successful": true
    }
  }
  ```
3. **List SMS conversations**
  ```json
  {
    "sender": "phone",
    "type": "sms",
    "subtype": "get_sms_conversations",
    "request_id": "123e4567-e89b-12d3-a456-426614174000",
    "data": [
      {
        "phone_number": "+123456789",
        "contact_name": "John Doe",
        "last_message": "Hello, how are you?",
        "timestamp": "2024-12-06T14:30:00Z",
        "is_read": true,
        "is_sent_by_me": true
      },
      {
        "phone_number": "+987654321",
        "contact_name": "Lil Wayne",
        "last_message": "Yo whatsup G?",
        "timestamp": "2024-12-06T14:00:00Z",
        "is_read": false,
        "is_sent_by_me": false
      }
    ]
  }
  ```
4. **List SMS messages from a conversation**
  ```json
  {
    "sender": "phone",
    "type": "sms",
    "subtype": "get_conversation_messages",
    "request_id": "123e4567-e89b-12d3-a456-426614174000",
    "data": [
      {
        "phone_number": "+123456789",
        "contact_name": "John Doe",
        "message": "Hello, how are you?",
        "timestamp": "2024-12-06T14:30:00Z",
        "is_read": true,
        "is_sent_by_me": true
      },
      {
        "phone_number": "+234567891",
        "contact_name": "Jane Doe",
        "message": "I'm good, thanks for asking!",
        "timestamp": "2024-12-06T14:31:00Z",
        "is_read": false,
        "is_sent_by_me": false
      }
    ]
  }
  ```
5. **Get a confirmation that the SMS was sent**
  ```json
  {
    "sender": "phone",
    "type": "sms",
    "subtype": "send_sms",
    "request_id": "123e4567-e89b-12d3-a456-426614174000",
    "data": {
      "recipient": "+123456789",
      "is_successful": true
    }
  }
  ```

### Android app
The Android app is responsible for handling the phone's functionalities. It communicates with the server to perform actions like sending SMS, making calls, and adjusting volume. The app is built using Kotlin and requires the Android SDK to compile and run.  
More information can be found in its respective [README](android/README.md).

### Version bump
When making changes to this plugin, you must edit the version in 3 places :  
- [`build.gradle`](./build.gradle) : Update the `version` field.
- [`android/app/build.gradle.kts`](android/app/build.gradle.kts) : Update the `android.defaultConfig.versionName` field.
- [`android/app/src/main/res/values/strings.xml`](android/app/src/main/res/values/strings.xml) : Update the `version` field.

This ensures that the plugin and app's version matches, and upon installation you can visually check if the new version is indeed being used.

This plugin follows the [Semantic Versioning](https://semver.org/) guidelines :  
- **Major (X.0.0)** : Breaking changes.
- **Minor (0.X.0)** : New features.
- **Patch (0.0.X)** : Bug fixes.  

Versions `1.X.X` are the ones that were created during the inception of the plugin, and any `2.X.X+` versions are the stable ones that have been created once the plugin was completed.
